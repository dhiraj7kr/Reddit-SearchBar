<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Search Results - Reddit</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    :root{
      --accent:#ff4500;
      --bg:#111;
      --card:#1a1a1a;
      --muted:#888;
      --text:#fff;
    }
    *{box-sizing:border-box}
    body{
      font-family:'Roboto',sans-serif;
      background:var(--bg);
      color:var(--text);
      margin:0;padding:20px;display:flex;flex-direction:column;align-items:center;min-height:100vh;
    }

    .container{width:100%;max-width:1000px}

    h1{font-size:1.6rem;color:var(--accent);margin:0 0 14px;text-align:center}

    .top-row{display:flex;gap:10px;align-items:center;margin-bottom:14px}
    #search-container{display:flex;gap:10px;flex:1;align-items:center}
    
    /* Home Button Style */
    .home-btn {
        background: #222;
        color: #fff;
        border: 1px solid #333;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
        transition: 0.2s;
        font-size: 1.1rem;
    }
    .home-btn:hover {
        background: var(--accent);
        border-color: var(--accent);
    }

    #query{flex:1;padding:8px 12px;border-radius:24px;border:1px solid #333;background:#fff;color:#222}
    .btn{background:var(--accent);color:#fff;padding:8px 12px;border-radius:20px;border:none;cursor:pointer}
    .tabs{display:flex;gap:8px}
    .tab{padding:8px 12px;border-radius:18px;background:#222;color:#ccc;cursor:pointer;border:1px solid transparent}
    .tab.active{background:linear-gradient(90deg, rgba(255,69,0,0.12), rgba(255,69,0,0.05));color:var(--accent);border-color:rgba(255,69,0,0.18)}

    .content{background:transparent;width:100%}
    .results-list{margin-top:8px;display:block}
    .result{background:var(--card);padding:14px;border-radius:10px;margin-bottom:12px;display:flex;gap:12px;align-items:flex-start}
    .result-body{flex:1}
    .result h3{margin:0 0 8px;font-size:1.08rem;color:var(--accent)}
    .result p{margin:0 0 8px;color:#d0d0d0;line-height:1.45}
    .metadata{font-size:0.85rem;color:var(--muted)}
    .thumbnail img{width:220px;height:140px;object-fit:cover;border-radius:6px}

    /* images grid */
    #images-container{display:none;margin-top:8px}
    .images-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
    .image-card{background:#0f0f0f;border-radius:10px;overflow:hidden;height:160px;position:relative;display:flex;align-items:center;justify-content:center;cursor:pointer}
    .image-card img{width:100%;height:100%;object-fit:cover}
    .image-caption{position:absolute;bottom:6px;left:6px;right:6px;color:#fff;font-size:0.85rem;background:linear-gradient(0deg, rgba(0,0,0,0.6), transparent);padding:6px;border-radius:6px;display:flex;gap:8px;align-items:center}

    .pagination{display:flex;gap:8px;align-items:center;justify-content:center;margin-top:16px}
    .page-btn{padding:8px 12px;border-radius:8px;border:1px solid #222;background:#222;color:#ccc;cursor:pointer}
    .page-btn[disabled]{opacity:0.45;cursor:not-allowed}
    .page-info{color:var(--muted);font-size:0.95rem}

    .loader{display:flex;align-items:center;justify-content:center;gap:8px;color:var(--muted); padding: 20px;}
    .no-results{padding:18px;background:#161616;border-radius:8px;color:#ccc;margin-top:12px;text-align:center}

    /* modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.75);z-index:9999}
    .modal.active{display:flex}
    .modal img{max-width:92%;max-height:86%;border-radius:8px}
    .close-btn{position:absolute;top:18px;right:22px;background:rgba(0,0,0,0.45);color:#fff;border:1px solid rgba(255,255,255,0.08);padding:8px 10px;border-radius:6px;cursor:pointer}

    @media(max-width:680px){ .thumbnail img{width:140px;height:98px} .result{flex-direction:column} }
  </style>
</head>
<body>
  <div class="container">
    <h1>Search Results for: <span id="query-text"></span></h1>

    <div class="top-row">
      <a href="index.html" class="home-btn" title="Go Home">
        <i class="fas fa-home"></i>
      </a>

      <div id="search-container">
        <input id="query" type="text" placeholder="Search Reddit..." onkeydown="if(event.key==='Enter') goSearch()" />
        <button id="search-btn" class="btn" onclick="goSearch()">Search</button>
      </div>

      <div class="tabs" role="tablist" aria-label="Results tabs">
        <div class="tab active" id="tab-all" onclick="switchTab('all')">All</div>
        <div class="tab" id="tab-images" onclick="switchTab('images')">Images</div>
      </div>
    </div>

    <div class="content">
      <div id="loader" class="loader" style="display:none">Loading data...</div>

      <div id="results-section">
        <div id="results-container" class="results-list"></div>
        <div id="no-results" class="no-results" style="display:none">No relevant posts found on Reddit.</div>
      </div>

      <div id="images-container">
        <div id="images-grid" class="images-grid"></div>
      </div>

      <div class="pagination" id="pagination" style="display:none">
        <button id="prev-btn" class="page-btn" onclick="prevPage()">Previous</button>
        <div class="page-info">
          Page <strong id="page-num">1</strong>
        </div>
        <button id="next-btn" class="page-btn" onclick="nextPage()">Next</button>
      </div>
    </div>

    <div style="height:28px"></div>

    <div class="navigation" style="display:flex;gap:12px;color:#ccc;font-size:14px;justify-content: center;">
      <a href="index.html" style="color:#ccc;text-decoration:none">Back to Home</a>
      <a href="#" style="color:#ccc;text-decoration:none">Contact</a>
    </div>
  </div>

  <div class="modal" id="image-modal" role="dialog" aria-modal="true" aria-hidden="true">
    <button class="close-btn" onclick="closeModal()">Close ✕</button>
    <img id="modal-img" src="" alt="Large view">
  </div>

  <script>
    /* ---------- Config ---------- */
    const BACKEND_BASE = 'http://127.0.0.1:5000'; 
    
    /* ---------- State ---------- */
    const urlParams = new URLSearchParams(window.location.search);
    let currentQuery = urlParams.get('query') || '';
    
    // Pagination State
    let pageTokens = ['']; // Index 0 is Page 1 (which has no 'after' token)
    let pageIndex = 0; // 0-based index

    // UI elements
    const qText = document.getElementById('query-text');
    const qInput = document.getElementById('query');
    const resultsContainer = document.getElementById('results-container');
    const imagesGrid = document.getElementById('images-grid');
    const imagesContainer = document.getElementById('images-container');
    const noResults = document.getElementById('no-results');
    const loader = document.getElementById('loader');
    const pagination = document.getElementById('pagination');
    const pageNumEl = document.getElementById('page-num');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');

    // initialize UI
    qText.textContent = currentQuery;
    qInput.value = currentQuery;

    /* ---------- Logic ---------- */

    function switchTab(tab) {
      const allTab = document.getElementById('tab-all');
      const imgTab = document.getElementById('tab-images');
      if (tab === 'images') {
        imgTab.classList.add('active');
        allTab.classList.remove('active');
        document.getElementById('results-section').style.display = 'none';
        imagesContainer.style.display = 'block';
      } else {
        allTab.classList.add('active');
        imgTab.classList.remove('active');
        document.getElementById('results-section').style.display = 'block';
        imagesContainer.style.display = 'none';
      }
    }

    function goSearch() {
      const q = qInput.value.trim();
      if (!q) return;
      currentQuery = q;
      
      // Reset State
      pageTokens = [''];
      pageIndex = 0;
      
      qText.textContent = currentQuery;
      // Update URL without reloading
      const u = new URL(window.location.href);
      u.searchParams.set('query', currentQuery);
      window.history.replaceState({}, '', u.toString());
      
      loadData();
    }

    function nextPage() {
        if (pageIndex < pageTokens.length - 1) {
            pageIndex++;
            loadData();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    }

    function prevPage() {
        if (pageIndex > 0) {
            pageIndex--;
            loadData();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    }

    /* ---------- Fetch & Render ---------- */
    async function loadData() {
      if (!currentQuery) return;
      
      setLoading(true);
      
      // Get the token for the current page
      const afterToken = pageTokens[pageIndex] || '';

      try {
        const resp = await fetch(`${BACKEND_BASE}/get-answer?query=${encodeURIComponent(currentQuery)}&after=${afterToken}`);
        if (!resp.ok) throw new Error('Network error');
        
        const data = await resp.json();
        
        // Handle "Next" token logic
        // If we are on the last known page, and server gives a new token, add it to stack
        if (data.after && pageIndex === pageTokens.length - 1) {
            pageTokens.push(data.after);
        }

        renderPage(data.results);
        updatePaginationUI(data.after);

      } catch (err) {
        console.error('Error loading data:', err);
        resultsContainer.innerHTML = '';
        noResults.style.display = 'block';
        noResults.textContent = 'Error loading results.';
      } finally {
        setLoading(false);
      }
    }

    function updatePaginationUI(serverNextToken) {
        pageNumEl.textContent = pageIndex + 1;
        
        // Enable Prev if index > 0
        prevBtn.disabled = (pageIndex === 0);
        
        // Enable Next if we have a token for the next page OR the server just gave us one
        const hasNext = (pageIndex < pageTokens.length - 1) || (!!serverNextToken);
        nextBtn.disabled = !hasNext;
        
        pagination.style.display = 'flex';
    }

    function renderPage(results) {
      resultsContainer.innerHTML = '';
      imagesGrid.innerHTML = '';
      noResults.style.display = 'none';

      if (!results || !results.length) {
        noResults.style.display = 'block';
        imagesGrid.innerHTML = `<div style="color:#ccc;padding:18px;">No images found.</div>`;
        return;
      }

      results.forEach(r => {
        // --- Text Card ---
        const card = document.createElement('div');
        card.className = 'result';

        if (r.image_url) {
          const thumbWrap = document.createElement('div');
          thumbWrap.className = 'thumbnail';
          const img = document.createElement('img');
          img.src = sanitizeImageUrl(r.image_url);
          img.onerror = () => { img.style.display = 'none'; };
          thumbWrap.appendChild(img);
          card.appendChild(thumbWrap);
        }

        const body = document.createElement('div');
        body.className = 'result-body';

        const h3 = document.createElement('h3');
        const a = document.createElement('a');
        a.href = r.url || '#';
        a.target = '_blank';
        a.textContent = r.title || 'Untitled';
        a.style.color = 'inherit';
        h3.appendChild(a);

        const p = document.createElement('p');
        p.textContent = r.description || '';

        const meta = document.createElement('div');
        meta.className = 'metadata';
        meta.textContent = `By ${r.author || 'unknown'} • ${r.created_at || ''}`;
        
        // "See More" / Full Text Toggle
        if (r.full_description && r.full_description.length > r.description.length) {
             const toggleBtn = document.createElement('span');
             toggleBtn.textContent = " [Show More]";
             toggleBtn.style.color = "var(--accent)";
             toggleBtn.style.cursor = "pointer";
             toggleBtn.style.fontSize = "0.9rem";
             toggleBtn.onclick = function() {
                 if(p.textContent === r.description) {
                     p.textContent = r.full_description;
                     toggleBtn.textContent = " [Show Less]";
                 } else {
                     p.textContent = r.description;
                     toggleBtn.textContent = " [Show More]";
                 }
             };
             meta.appendChild(toggleBtn);
        }

        body.appendChild(h3);
        body.appendChild(p);
        body.appendChild(meta);
        card.appendChild(body);
        resultsContainer.appendChild(card);

        // --- Image Grid Item ---
        if (r.image_url) {
          const imgCard = document.createElement('div');
          imgCard.className = 'image-card';
          imgCard.onclick = () => openModal(r.image_url, r.title);
          
          const gImg = document.createElement('img');
          gImg.src = sanitizeImageUrl(r.image_url);
          imgCard.appendChild(gImg);
          
          const cap = document.createElement('div');
          cap.className = 'image-caption';
          cap.innerHTML = `<strong>${escapeHtml(r.title)}</strong>`;
          imgCard.appendChild(cap);
          
          imagesGrid.appendChild(imgCard);
        }
      });
      
      // If no images
      if (!imagesGrid.children.length) {
         imagesGrid.innerHTML = `<div style="color:#ccc;padding:18px;">No images in this batch.</div>`;
      }
    }

    /* ---------- Utils ---------- */
    function sanitizeImageUrl(url) {
      if (!url) return '';
      let u = String(url).trim().replace(/&amp;/g, '&');
      if (u.startsWith('//')) u = 'https:' + u;
      return u;
    }
    
    function escapeHtml(str) {
      if (!str) return '';
      return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    function setLoading(state) {
      loader.style.display = state ? 'flex' : 'none';
    }

    /* ---------- Modal ---------- */
    function openModal(src, alt) {
      const modal = document.getElementById('image-modal');
      const img = document.getElementById('modal-img');
      img.src = sanitizeImageUrl(src);
      modal.classList.add('active');
    }
    function closeModal() {
      document.getElementById('image-modal').classList.remove('active');
    }
    document.getElementById('image-modal').addEventListener('click', (e) => {
      if (e.target.id === 'image-modal') closeModal();
    });

    /* ---------- Init ---------- */
    (function init(){
      if (currentQuery) loadData();
      else {
          document.getElementById('results-container').innerHTML = ''; 
          pagination.style.display = 'none';
      }
    })();
  </script>
</body>
</html>